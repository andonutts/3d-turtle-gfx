<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>3D Turtle Graphics Renderer</title>
        <style>
        </style>
    </head>
    <body>
        <script src="js/three.js"></script>
        <script src="js/controls/OrbitControls.js"></script>
        <script src="js/Detector.js"></script>
        <script src="js/MV.js"></script>
        <script>
            if ( !Detector.webgl ) {
                Detector.addGetWebGLMessage();
            }

            var renderer, scene, camera, controls;

            init();
            addGeometry();
            animate();

            function init() {
                var canvasWidth = 800;
                var canvasHeight = 512;

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setSize( canvasWidth, canvasHeight );
                renderer.setClearColor( 0xf2f2f2, 1.0 );
                document.body.appendChild( renderer.domElement );

                camera = new THREE.PerspectiveCamera( 45, canvasWidth / canvasHeight, 1, 1000 );
                camera.position.set( 50, 50, 50 );
                camera.lookAt( new THREE.Vector3( 0, 0, 0 ) );

                scene = new THREE.Scene();
                
                controls = new THREE.OrbitControls( camera, renderer.domElement );
                controls.enablePan = false;
                controls.minDistance = 10;
                controls.maxDistance = 500;
            }

            function addGeometry() {
                var command;
                var ruleset = [];
                var iterations;
                var turnAngle;
                var stepSize;

                iterations = 3;
                turnAngle = 90;
                stepSize = 3;

                command = "A";
                ruleset["A"] = "B-F+CFC+F-D&F^D-F+&&CFC+F+B//";
                ruleset["B"] = "A&F^CFB^F^D^^-F-D^|F^B|FC^F^A//";
                ruleset["C"] = "|D^|F^B-F+C^F^A&&FA&F^C+F+B^F^D//";
                ruleset["D"] = "|CFB-F+B|FA&F^A&&FB-F+B|FC//";

                var turters = new Turtle(stepSize, turnAngle);

                var commandEx = processLSystem(iterations, command, ruleset);
                drawLSystem(turters, commandEx);
            }

            function animate() {
                requestAnimationFrame( animate );
                renderer.render( scene, camera );
            }

            function Turtle(stepSize, turnAngle) {
                this.stepSize = stepSize;
                this.turnAngle = turnAngle * Math.PI / 180;
                this.stateStack = [];

                // initialize at origin
                this.position = vec3( 0, 0, 0 );

                // initialize heading in the +y direction
                this.hlu = mat3(
                    0, 1, 0,
                    1, 0, 0,
                    0, 0, -1
                );

                this.moveForward = function() {
                    var h = vec3(
                        this.hlu[0][0],
                        this.hlu[1][0],
                        this.hlu[2][0]
                    );

                    var material = new THREE.LineBasicMaterial( { color: 0x4c4c4c } );
                    var geometry = new THREE.Geometry();

                    geometry.vertices.push(new THREE.Vector3(
                        this.position[0],
                        this.position[1],
                        this.position[2]
                    ));

                    this.position = add(this.position, scale(stepSize, h));

                    geometry.vertices.push(new THREE.Vector3(
                        this.position[0],
                        this.position[1],
                        this.position[2]
                    ));

                    var line = new THREE.Line( geometry, material );
                    scene.add( line );
                }

                this.turnLeft = function() {
                    var d = -this.turnAngle;
                    var rot = mat3(
                        Math.cos(d), Math.sin(d), 0,
                        -Math.sin(d), Math.cos(d), 0,
                        0, 0, 1
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.turnRight = function() {
                    var d =  this.turnAngle;
                    var rot = mat3(
                        Math.cos(d), Math.sin(d), 0,
                        -Math.sin(d), Math.cos(d), 0,
                        0, 0, 1
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.pitchDown = function() {
                    var d = -this.turnAngle;
                    var rot = mat3(
                        Math.cos(d), 0, -Math.sin(d),
                        0, 1, 0,
                        Math.sin(d), 0, Math.cos(d)
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.pitchUp = function() {
                    var d = this.turnAngle;
                    var rot = mat3(
                        Math.cos(d), 0, -Math.sin(d),
                        0, 1, 0,
                        Math.sin(d), 0, Math.cos(d)
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.rollLeft = function() {
                    var d = -this.turnAngle;
                    var rot = mat3(
                        1, 0, 0,
                        0, Math.cos(d), -Math.sin(d),
                        0, Math.sin(d), Math.cos(d)
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.rollRight = function() {
                    var d = this.turnAngle;
                    var rot = mat3(
                        1, 0, 0,
                        0, Math.cos(d), -Math.sin(d),
                        0, Math.sin(d), Math.cos(d)
                    );
                    this.hlu = mult(this.hlu, rot);
                };

                this.turnAround = function() {
                    var rot = mat3(
                        -1, 0, 0,
                        0, -1, 0,
                        0, 0, 1
                    );
                    this.hlu = mult(this.hlu, rot);
                }

                this.pushState = function() {
                    var turtleState = {
                        position : this.position,
                        hlu : this.hlu
                    };
                    this.stateStack.push(turtleState);
                };

                this.popState = function() {
                    var turtleState = this.stateStack.pop();
                    this.position = turtleState["position"];
                    this.hlu = turtleState["hlu"];
                };
            }

            function processLSystem(iterations, command, ruleset) {
                var re = /[\+\-\&\^\\\/\|\[\]]/g;
                for(var i = 0; i < iterations; i++) {
                    var buffer = "";
                    for(var j = 0; j < command.length; j++) {
                        var symbol = command.charAt(j);
                        if(!re.test(symbol) && ruleset[symbol] != null) {
                            buffer += ruleset[symbol];
                        } else {
                            buffer += symbol;
                        }
                    }
                    command = buffer;
                }
                return command;
            }

            function drawLSystem(turtle, command) {
                for(var i = 0; i < command.length; i++) {
                    switch(command.charAt(i)) {
                        case "F":
                            turtle.moveForward();
                            break;
                        case "+":
                            turtle.turnLeft();
                            break;
                        case "-":
                            turtle.turnRight();
                            break;
                        case "&":
                            turtle.pitchDown();
                            break;
                        case "^":
                            turtle.pitchUp();
                            break;
                        case "\\":
                            turtle.rollLeft();
                            break;
                        case "/":
                            turtle.rollRight();
                            break;
                        case "|":
                            turtle.turnAround();
                            break;
                        case "[":
                            turtle.pushState();
                            break;
                        case "]":
                            turtle.popState();
                            break;
                        default:

                    }
                }
            }

            function addRule() {
                var ruleTable = document.getElementById("rule-table");
                var row = ruleTable.insertRow();
                var symbolCell = row.insertCell();
                var ruleCell = row.insertCell();
                var deleteCell = row.insertCell();

                symbolCell.innerHTML = '<input type="text" class="symbol-input" />';
                ruleCell.innerHTML = '<input type="text" class="rule-input" />';
                deleteCell.innerHTML = '<button onclick="deleteRule(this)">Delete Rule</button>'
            }

            function deleteRule(r) {
                var i = r.parentNode.parentNode.rowIndex;
                document.getElementById("rule-table").deleteRow(i);
            }

        </script>
        <div>
            <label><span>n</span><input type="text" id="order" /></label><br />
            <label><span>&delta;</span><input type="text" id="turn-angle" /></label><br />
            <label><span>Base axiom</span><input type="text" id="base-axiom" /></label><br />
            <table id="rule-table">
                <tr>
                    <th>Symbol</th>
                    <th>Rule</th>
                </tr>
                <tr>
                    <td><input type="text" class="symbol-input" /></td>
                    <td><input type="text" class="rule-input" /></td>
                </tr>
            </table>
            <button onclick="addRule()">Add New Rule</button><br />
            <button onclick="generateModel()">Generate</button>
        </div>
    </body>
</html>
